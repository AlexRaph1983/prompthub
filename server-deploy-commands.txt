#!/bin/bash
# ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð°Ð´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
# Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÑÑ‚Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¿Ð¾ Ð¿Ð¾Ñ€ÑÐ´ÐºÑƒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ

cd /root/prompthub

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿
echo "ðŸ’¾ Creating backup..."
cp -r /root/prompthub /root/prompthub_backup_$(date +%Y%m%d_%H%M%S)

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "â¹ï¸ Stopping application..."
pm2 stop all

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´
echo "ðŸ“¥ Updating code..."
git fetch origin
git reset --hard origin/main

# Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ”§ Installing dependencies..."
rm -rf node_modules package-lock.json
npm install

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "ðŸ—„ï¸ Updating database..."
npx prisma db push
npx prisma generate

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð´Ð¼Ð¸Ð½ÑÐºÐ¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿
echo "ðŸ” Setting up admin access..."
cat > .env.local << 'EOF'
ADMIN_EMAIL=your-email@gmail.com
ADMIN_API_KEY=admin-secret-key-123
EOF

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸ—ï¸ Building application..."
npm run build

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼
if [ -f ".next/BUILD_ID" ]; then
    echo "âœ… Build successful!"
    
    echo "ðŸš€ Starting application..."
    pm2 start all
    pm2 save
    
    sleep 10
    
    echo "ðŸ“Š Application status:"
    pm2 status
    
    echo "ðŸŒ Testing site:"
    curl -s -o /dev/null -w "HTTP %{http_code}" http://localhost:3000
    echo ""
    
    echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
    echo "âœ… Site: http://YOUR_SERVER_IP_HERE:3000"
    echo "âœ… Admin Panel: http://YOUR_SERVER_IP_HERE:3000/admin"
    echo ""
    echo "ðŸ“‹ NEXT STEPS:"
    echo "1. Edit .env.local file:"
    echo "   nano .env.local"
    echo "   Replace 'your-email@gmail.com' with your real Gmail"
    echo "2. Restart application: pm2 restart all"
    echo "3. Login to site with Google OAuth"
    echo "4. Go to /admin to use admin panel!"
    
else
    echo "âŒ Build failed! Rolling back..."
    LATEST_BACKUP=$(ls -td /root/prompthub_backup_* | head -1)
    if [ -n "$LATEST_BACKUP" ]; then
        echo "ðŸ“¦ Restoring from: $LATEST_BACKUP"
        rm -rf /root/prompthub
        mv "$LATEST_BACKUP" /root/prompthub
        cd /root/prompthub
        pm2 start all
        echo "âœ… Rollback completed"
    fi
fi

echo ""
echo "ðŸ” FINAL CHECK:"
echo "PM2 Status:"
pm2 status
echo ""
echo "External access test:"
curl -s -o /dev/null -w "HTTP %{http_code} - " http://YOUR_SERVER_IP_HERE:3000 && echo "Site working"
curl -s -o /dev/null -w "HTTP %{http_code} - " http://YOUR_SERVER_IP_HERE:3000/admin && echo "Admin panel accessible"

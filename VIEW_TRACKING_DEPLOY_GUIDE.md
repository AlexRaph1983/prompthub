# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä
npm run lint

# –ó–∞–ø—É—Å—Ç–∏—Ç—å unit-—Ç–µ—Å—Ç—ã
npm test __tests__/track-view.test.ts

# –ó–∞–ø—É—Å—Ç–∏—Ç—å E2E —Ç–µ—Å—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
npx playwright test __tests__/e2e/view-tracking.spec.ts
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω:

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
redis-cli ping
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: PONG

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh root@REDACTED_IP "redis-cli ping"
```

### 3. –î–µ–ø–ª–æ–π –Ω–∞ production

```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É –¥–µ–ø–ª–æ—è –∏–∑ workspace rules
cd /root/prompthub && \
git fetch origin && \
git reset --hard origin/main && \
bash scripts/deploy.sh
```

**–í–ê–ñ–ù–û:** –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ migrate/seed —Å–∫—Ä–∏–ø—Ç—ã –≤ –ø—Ä–æ–¥–µ!

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

#### A. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@REDACTED_IP

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ PM2
pm2 logs prompthub --lines 50 | grep TRACK-VIEW

# –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –ª–æ–≥–∏ –≤–∏–¥–∞:
# [TRACK-VIEW:abc12345] API called
# [TRACK-VIEW:abc12345] Processing
# [TRACK-VIEW:abc12345] Views incremented
```

#### B. Smoke test –Ω–∞ production
```bash
# 1. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
curl -X POST https://prompt-hub.site/api/view-token \
  -H 'Content-Type: application/json' \
  --data '{"cardId":"<EXISTING_PROMPT_ID>","fingerprint":"smoke-test-fp"}' \
  | jq .

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
# {
#   "viewToken": "simple-1736698800000-xyz123...",
#   "expiresIn": 600
# }

# 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
TOKEN="<–ø–æ–ª—É—á–µ–Ω–Ω—ã–π_—Ç–æ–∫–µ–Ω>"
curl -X POST https://prompt-hub.site/api/track-view \
  -H 'Content-Type: application/json' \
  -H 'x-fingerprint: smoke-test-fp' \
  -H 'referer: https://prompt-hub.site/prompt/<EXISTING_PROMPT_ID>' \
  --data "{\"cardId\":\"<EXISTING_PROMPT_ID>\",\"viewToken\":\"$TOKEN\"}" \
  | jq .

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
# {
#   "counted": true,
#   "views": <—á–∏—Å–ª–æ>
# }

# 3. –ü–æ–≤—Ç–æ—Ä–Ω–æ —Ç–µ–º –∂–µ —Ç–æ–∫–µ–Ω–æ–º (–¥–æ–ª–∂–Ω–æ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å—Å—è)
curl -X POST https://prompt-hub.site/api/track-view \
  -H 'Content-Type: application/json' \
  -H 'x-fingerprint: smoke-test-fp' \
  -H 'referer: https://prompt-hub.site/prompt/<EXISTING_PROMPT_ID>' \
  --data "{\"cardId\":\"<EXISTING_PROMPT_ID>\",\"viewToken\":\"$TOKEN\"}" \
  | jq .

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
# {
#   "error": "INVALID_OR_REUSED_TOKEN",
#   "reason": "TOKEN_REUSED",
#   "counted": false
# }
```

#### C. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
1. –û—Ç–∫—Ä—ã—Ç—å DevTools ‚Üí Console
2. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ª—é–±—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–º–ø—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
   ```
   [VIEW_TRACKING] Starting track view
   [VIEW_TRACKING] Token response
   [VIEW_TRACKING] Sending track-view request
   [VIEW_TRACKING] Track-view response
   [VIEW_TRACKING] Completed and marked as tracked
   ```
4. –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é ‚Üí –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–æ–≤—ã—Ö `[VIEW_TRACKING]` –ª–æ–≥–æ–≤
5. –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ç–æ—Ç –∂–µ –ø—Ä–æ–º–ø—Ç ‚Üí –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–æ–≥ `Skipped - already tracked in session`

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î (SQL)
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
SELECT 
  reason, 
  COUNT(*) AS count
FROM "PromptViewEvent" 
WHERE 
  "isCounted" = false
  AND "createdAt" > NOW() - INTERVAL '1 hour'
GROUP BY reason
ORDER BY count DESC;

-- –û–∂–∏–¥–∞–µ–º—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
-- TOKEN_REUSED, DEDUP_WINDOW, INVALID_REFERER, AF_BLOCKED
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis –∫–ª—é—á–µ–π
```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@REDACTED_IP

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–æ–∫–µ–Ω—ã
redis-cli --scan --pattern "token:used:*" | head -5

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
redis-cli --scan --pattern "view:dedupe:*" | head -5

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TTL –∫–ª—é—á–∞
redis-cli TTL "token:used:<–Ω–µ–∫–æ—Ç–æ—Ä—ã–π_—Ç–æ–∫–µ–Ω>"
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —á–∏—Å–ª–æ —Å–µ–∫—É–Ω–¥ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è (–¥–æ 3600)
```

## –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

### –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ Git

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /root/prompthub

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã
git log --oneline -5

# –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç
git reset --hard <previous_commit_hash>

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
pm2 restart prompthub

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs prompthub
```

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∫–∞–∫—É—é-—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫—É:

```typescript
// app/api/track-view/route.ts

// –û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç—å
// –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ 57-68

// –û—Ç–∫–ª—é—á–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é
// –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ 105-118

// –û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É Referer
// –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ 70-88
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∏ –≤–∏–¥–∞ `Error: connect ECONNREFUSED 127.0.0.1:6379`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Redis
systemctl status redis

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
systemctl start redis

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback –±–µ–∑ Redis (–≤—Ä–µ–º–µ–Ω–Ω–æ)
# –í track-view.route.ts –¥–æ–±–∞–≤–∏—Ç—å try-catch –≤–æ–∫—Ä—É–≥ Redis –æ–ø–µ—Ä–∞—Ü–∏–π
```

### –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π

**–°–∏–º–ø—Ç–æ–º:** –ú–Ω–æ–≥–æ `{counted: false, reason: 'DEDUP_WINDOW'}`

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—é—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É < 30s

**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–∏—Ç—å –æ–∫–Ω–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:
```typescript
// app/api/track-view/route.ts, —Å—Ç—Ä–æ–∫–∞ 102
const dedupWindowSeconds = 15 // –±—ã–ª–æ 30
```

### –ü—Ä–æ–±–ª–µ–º–∞: –õ–æ–≥–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** Production build –º–æ–∂–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å console.log

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å structured logging:
```typescript
import { logger } from '@/lib/logger'
logger.info('[TRACK-VIEW]', { data })
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (.env.local)
```bash
# Redis (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
REDIS_URL=redis://localhost:6379

# View tracking (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è)
VIEW_SALT=your-development-salt-change-in-production

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–∏—á–∞-—Ñ–ª–∞–≥–∏
VIEW_DEDUP_WINDOW=30          # –°–µ–∫—É–Ω–¥—ã –æ–∫–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
VIEW_TOKEN_TTL=3600           # –°–µ–∫—É–Ω–¥—ã TTL —Ç–æ–∫–µ–Ω–∞ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

### Production (.env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
ssh root@REDACTED_IP "cat /root/prompthub/.env | grep VIEW"

# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
VIEW_SALT=<—Å–∏–ª—å–Ω—ã–π_—Å–ª—É—á–∞–π–Ω—ã–π_—Å–µ–∫—Ä–µ—Ç>
REDIS_URL=redis://localhost:6379
```

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–µ–ø–ª–æ—è

- [ ] –í—Å–µ unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Redis –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] VIEW_SALT –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env
- [ ] –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω —á–µ—Ä–µ–∑ `bash scripts/deploy.sh`
- [ ] PM2 –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ—à–∏–±–æ–∫
- [ ] Smoke test –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
- [ ] –ë—Ä–∞—É–∑–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –≤ –ë–î –≤—ã–≥–ª—è–¥—è—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- [ ] Redis –∫–ª—é—á–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏

–ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `pm2 logs prompthub --lines 200`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis: `redis-cli ping`
3. –û—Ç–∫–∞—Ç–∏—Ç—å –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ: `git reset --hard <previous_commit>`
4. –°–æ–æ–±—â–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É —Å –ª–æ–≥–∞–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç: `VIEW_TRACKING_FIX_REPORT.md`
- Unit-—Ç–µ—Å—Ç—ã: `__tests__/track-view.test.ts`
- E2E —Ç–µ—Å—Ç—ã: `__tests__/e2e/view-tracking.spec.ts`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: —Å–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á—ë—Ç –≤ —á–∞—Ç–µ

**–î–µ–ø–ª–æ–π –≥–æ—Ç–æ–≤. –£–¥–∞—á–∏! üöÄ**


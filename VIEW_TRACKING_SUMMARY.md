# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ - –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
–°—á—ë—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —É–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è –¥–≤–∞–∂–¥—ã: –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ –∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é.

### –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ **5 —É—Ä–æ–≤–Ω–µ–π –∑–∞—â–∏—Ç—ã** –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞:

1. **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞—â–∏—Ç–∞** - sessionStorage + —Ñ–ª–∞–≥–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
2. **–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã** - Redis, TTL 1 —á–∞—Å
3. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** - 30-—Å–µ–∫—É–Ω–¥–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ Redis
4. **Referer –ø—Ä–æ–≤–µ—Ä–∫–∞** - —Ç–æ–ª—å–∫–æ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–º–ø—Ç–∞
5. **–ê–Ω—Ç–∏—Ñ—Ä–æ–¥** - User-Agent, IP, fingerprint –ø—Ä–æ–≤–µ—Ä–∫–∏

## üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
- ‚úÖ `app/(public)/prompt/[id]/PromptDetailsClient.tsx` - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–µ—Ä–µ–¥–∞—á–∞ x-fingerprint
- ‚úÖ `app/api/track-view/route.ts` - –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, referer check

### –¢–µ—Å—Ç—ã
- ‚úÖ `__tests__/track-view.test.ts` - 6 unit-—Ç–µ—Å—Ç–æ–≤
- ‚úÖ `__tests__/e2e/view-tracking.spec.ts` - 7 E2E —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `VIEW_TRACKING_FIX_REPORT.md` - –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- ‚úÖ `VIEW_TRACKING_DEPLOY_GUIDE.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é
- ‚úÖ `VIEW_TRACKING_SUMMARY.md` - —ç—Ç–æ —Ñ–∞–π–ª

## üöÄ –î–µ–ø–ª–æ–π

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ—Å—Ç—ã
npm test __tests__/track-view.test.ts

# 2. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å
cd /root/prompthub && \
git fetch origin && \
git reset --hard origin/main && \
bash scripts/deploy.sh

# 3. Smoke test
# –°–º. VIEW_TRACKING_DEPLOY_GUIDE.md
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ:** –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ ‚Üí +1 –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
**–ü–æ—Å–ª–µ:** –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è

### Acceptance Criteria ‚úÖ
- [x] –û–¥–∏–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä = –º–∞–∫—Å–∏–º—É–º 1 –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –∑–∞ 30 —Å–µ–∫—É–Ω–¥
- [x] –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç —Ç—Ä–µ–∫–∏–Ω–≥
- [x] –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- [x] –ù–µ–≤–µ—Ä–Ω—ã–π referer –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- [x] –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –õ–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```
[VIEW_TRACKING] - —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
[TRACK-VIEW:{id}] - –±—ç–∫–µ–Ω–¥
```

### –ü—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
- `TOKEN_REUSED` - –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- `DEDUP_WINDOW` - –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 30s –æ–∫–Ω–∞
- `INVALID_REFERER` - –Ω–µ–≤–µ—Ä–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
- `AF_BLOCKED` - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –∞–Ω—Ç–∏—Ñ—Ä–æ–¥–æ–º

### SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
```sql
SELECT reason, COUNT(*) 
FROM "PromptViewEvent" 
WHERE "isCounted" = false 
  AND "createdAt" > NOW() - INTERVAL '1 hour'
GROUP BY reason;
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Redis –∫–ª—é—á–∏
- `token:used:{token}` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (TTL 1h)
- `view:dedupe:{promptId}:{fp}:{window}` - –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (TTL 30s)

### Environment variables
```bash
VIEW_SALT=<secret>          # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
REDIS_URL=redis://localhost:6379
VIEW_DEDUP_WINDOW=30        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
```

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **Redis –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** - –±–µ–∑ –Ω–µ–≥–æ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. **VIEW_SALT** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω
3. **–ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å migrate/seed –≤ –ø—Ä–æ–¥–µ**

## üìñ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç:** `VIEW_TRACKING_FIX_REPORT.md`
- **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é:** `VIEW_TRACKING_DEPLOY_GUIDE.md`
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã:** –°–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç –≤ —á–∞—Ç–µ

## ‚ú® –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚úÖ
–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç ‚úÖ
–õ–∏–Ω—Ç–µ—Ä –±–µ–∑ –æ—à–∏–±–æ–∫ ‚úÖ
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ ‚úÖ

**–ú–æ–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å! üöÄ**


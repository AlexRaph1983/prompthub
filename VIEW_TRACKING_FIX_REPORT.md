# –û—Ç—á—ë—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤

## –î–∞—Ç–∞: 2025-01-12

## –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º:** –°—á—ë—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø—Ä–æ–º–ø—Ç–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è –¥–≤–∞–∂–¥—ã:
1. –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–º–ø—Ç–∞ (–æ–∂–∏–¥–∞–µ–º–æ)
2. –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–ù–ï –æ–∂–∏–¥–∞–µ–º–æ)

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

1. ‚úÖ **–¢—Ä–µ–∫–∏–Ω–≥ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ** - –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –≤—ã–∑–æ–≤–æ–≤ `/api/track-view` –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
2. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞** - –î–æ–±–∞–≤–ª–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å `mountId`, `fingerprint`, `pathname`, `timestamp`
3. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞** - –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
4. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤** - –¢–æ–∫–µ–Ω—ã –Ω–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–ª–∏—Å—å –Ω–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç—å
5. ‚úÖ **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** - –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
6. ‚úÖ **Referer –ø—Ä–æ–≤–µ—Ä–∫–∞** - –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø—Ä–æ—Å–∞
7. ‚úÖ **Fingerprint –ø–µ—Ä–µ–¥–∞—á–∞** - Fingerprint –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

| –ü—Ä–∏—á–∏–Ω–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|---------|----------|-------------|
| **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–æ–≤** | –¢–æ–∫–µ–Ω –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ | üî¥ HIGH |
| **–ù–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏** | –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ 30-—Å–µ–∫—É–Ω–¥–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ | üî¥ HIGH |
| **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ Referer** | –ó–∞–ø—Ä–æ—Å—ã –ø—Ä–∏–Ω–∏–º–∞–ª–∏—Å—å —Å –ª—é–±—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü | üü° MEDIUM |
| **Fingerprint –Ω–µ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ** | –ê–Ω—Ç–∏—Ñ—Ä–æ–¥ –Ω–µ –º–æ–≥ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å | üü° MEDIUM |

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ (`app/(public)/prompt/[id]/PromptDetailsClient.tsx`)

#### –î–æ–±–∞–≤–ª–µ–Ω–æ:
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[VIEW_TRACKING]`
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π `mountId` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ `x-fingerprint` –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ `/api/track-view`
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤: –Ω–∞—á–∞–ª–æ, –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞, –æ—Ç–≤–µ—Ç

#### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:
```javascript
[VIEW_TRACKING] Starting track view {
  promptId: "abc123",
  mountId: "7f8a9c2d",
  fingerprint: "a1b2c3d4",
  pathname: "/prompt/abc123",
  timestamp: "2025-01-12T10:30:00.000Z"
}

[VIEW_TRACKING] Track-view response {
  status: 200,
  ok: true,
  counted: true,
  views: 42,
  elapsed: "120ms"
}
```

### 2. –ë—ç–∫–µ–Ω–¥ (`app/api/track-view/route.ts`)

#### –î–æ–±–∞–≤–ª–µ–Ω–æ:

**A. –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤ (Redis)**
```typescript
const tokenUsedKey = `token:used:${viewToken}`
const tokenAlreadyUsed = await redis.get(tokenUsedKey)

if (tokenAlreadyUsed) {
  return NextResponse.json({ 
    error: 'INVALID_OR_REUSED_TOKEN',
    reason: 'TOKEN_REUSED',
    counted: false 
  }, { status: 400 })
}

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
await redis.set(tokenUsedKey, '1', 'EX', 3600) // TTL 1 —á–∞—Å
```

**B. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (30-—Å–µ–∫—É–Ω–¥–Ω–æ–µ –æ–∫–Ω–æ)**
```typescript
const dedupWindowSeconds = 30
const dedupKey = `view:dedupe:${cardId}:${fpHash}:${Math.floor(Date.now() / (dedupWindowSeconds * 1000))}`

const dedupResult = await redis.set(dedupKey, '1', 'NX', 'EX', dedupWindowSeconds)

if (dedupResult !== 'OK') {
  return NextResponse.json({ 
    counted: false,
    reason: 'DEDUP_WINDOW',
    views: prompt.views 
  }, { status: 200 })
}
```

**C. –ü—Ä–æ–≤–µ—Ä–∫–∞ Referer**
```typescript
const referer = req.headers.get('referer')
if (referer) {
  const refererUrl = new URL(referer)
  const isValidReferer = refererUrl.pathname.includes(`/prompt/${cardId}`)
  
  if (!isValidReferer) {
    return NextResponse.json({ 
      error: 'INVALID_REFERER_FOR_VIEW',
      reason: 'INVALID_REFERER',
      counted: false 
    }, { status: 400 })
  }
}
```

**D. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ fingerprint –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞**
```typescript
const fingerprint = req.headers.get('x-fingerprint')
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –∞–Ω—Ç–∏—Ñ—Ä–æ–¥–∞
```

**E. –ó–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏–π –≤ PromptViewEvent**
```typescript
await recordPromptViewEvent({
  promptId: cardId,
  userId: antifraudContext.userId || null,
  ipHash: ipHash || null,
  uaHash: uaHash || null,
  fpHash: fpHash || null,
  viewTokenId: viewToken,
  isCounted: true/false,
  reason: null –∏–ª–∏ 'DEDUP_WINDOW'/'TOKEN_REUSED'/'AF_BLOCKED'
})
```

#### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:
```
[TRACK-VIEW:a1b2c3d4] API called {
  referer: "https://prompt-hub.site/prompt/abc123",
  userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)...",
  ip: "1.2.3.4",
  fingerprint: "fp123456"
}

[TRACK-VIEW:a1b2c3d4] Processing {
  cardId: "abc123",
  tokenPrefix: "simple-170523..."
}

[TRACK-VIEW:a1b2c3d4] Incrementing views...

[TRACK-VIEW:a1b2c3d4] Views incremented {
  newCount: 43,
  elapsed: "85ms"
}
```

### 3. –¢–µ—Å—Ç—ã

#### Unit-—Ç–µ—Å—Ç—ã (`__tests__/track-view.test.ts`)
- ‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- ‚úÖ –¢–µ—Å—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –¢–µ—Å—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 30-—Å–µ–∫—É–Ω–¥–Ω–æ–≥–æ –æ–∫–Ω–∞
- ‚úÖ –¢–µ—Å—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ referer
- ‚úÖ –¢–µ—Å—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–Ω—Ç–∏—Ñ—Ä–æ–¥–æ–º
- ‚úÖ –¢–µ—Å—Ç 404 –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞

#### E2E —Ç–µ—Å—Ç—ã (`__tests__/e2e/view-tracking.spec.ts`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ–¥–∏–Ω–∏—á–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ–º–ø—Ç–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–¥—Å—á—ë—Ç–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ < 30s
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ x-fingerprint –∑–∞–≥–æ–ª–æ–≤–∫–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ referer
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ sessionStorage –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞—â–∏—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 1: –§—Ä–æ–Ω—Ç–µ–Ω–¥ (PromptDetailsClient)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ sessionStorage –ø—Ä–æ–≤–µ—Ä–∫–∞ (ph_prompt_viewed_{id})          ‚îÇ
‚îÇ ‚Ä¢ viewTrackedRef.current —Ñ–ª–∞–≥                               ‚îÇ
‚îÇ ‚Ä¢ cancelled —Ñ–ª–∞–≥ –¥–ª—è cleanup                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 2: –¢–æ–∫–µ–Ω (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π, Redis)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ token:used:{token} –≤ Redis                      ‚îÇ
‚îÇ ‚Ä¢ TTL 1 —á–∞—Å –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è                             ‚îÇ
‚îÇ ‚Ä¢ –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è SET NX                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 3: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (30s –æ–∫–Ω–æ, Redis)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ –ö–ª—é—á: view:dedupe:{promptId}:{fp/ip}:{timeWindow}        ‚îÇ
‚îÇ ‚Ä¢ SET NX EX 30 - –∞—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞             ‚îÇ
‚îÇ ‚Ä¢ –ü—Ä–∏–≤—è–∑–∫–∞ –∫ fingerprint ‚Üí IP ‚Üí UA                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 4: Referer –ø—Ä–æ–≤–µ—Ä–∫–∞                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ Referer –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å /prompt/{id}                     ‚îÇ
‚îÇ ‚Ä¢ –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 5: –ê–Ω—Ç–∏—Ñ—Ä–æ–¥ (AntifraudEngine)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ User-Agent –ø—Ä–æ–≤–µ—Ä–∫–∞ (–±–æ—Ç—ã, –∫—Ä–∞—É–ª–µ—Ä—ã)                      ‚îÇ
‚îÇ ‚Ä¢ Rate limiting (IP, fingerprint, userId)                   ‚îÇ
‚îÇ ‚Ä¢ Geolocation –ø—Ä–æ–≤–µ—Ä–∫–∞                                      ‚îÇ
‚îÇ ‚Ä¢ –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
                  ‚úÖ –ò–ù–ö–†–ï–ú–ï–ù–¢ VIEWS
```

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### Unit-—Ç–µ—Å—Ç—ã
```bash
npm run test __tests__/track-view.test.ts
```

### E2E —Ç–µ—Å—Ç—ã
```bash
npx playwright test __tests__/e2e/view-tracking.spec.ts
```

### Smoke-—Ç–µ—Å—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)
```bash
# 1. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
curl -X POST http://localhost:3000/api/view-token \
  -H 'Content-Type: application/json' \
  --data '{"cardId":"<PROMPT_ID>","fingerprint":"dev-fp-123"}' \
  | tee /tmp/token.json

# 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω (–ø–µ—Ä–≤—ã–π —Ä–∞–∑ - –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å)
TOKEN=$(jq -r '.viewToken' /tmp/token.json)
curl -X POST http://localhost:3000/api/track-view \
  -H 'Content-Type: application/json' \
  -H 'x-fingerprint: dev-fp-123' \
  -H 'referer: http://localhost:3000/prompt/<PROMPT_ID>' \
  --data "{\"cardId\":\"<PROMPT_ID>\",\"viewToken\":\"$TOKEN\"}"

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: {"counted":true,"views":N}

# 3. –ü–æ–≤—Ç–æ—Ä–Ω–æ —Ç–µ–º –∂–µ —Ç–æ–∫–µ–Ω–æ–º (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ)
curl -X POST http://localhost:3000/api/track-view \
  -H 'Content-Type: application/json' \
  -H 'x-fingerprint: dev-fp-123' \
  -H 'referer: http://localhost:3000/prompt/<PROMPT_ID>' \
  --data "{\"cardId\":\"<PROMPT_ID>\",\"viewToken\":\"$TOKEN\"}"

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: {"error":"INVALID_OR_REUSED_TOKEN","reason":"TOKEN_REUSED","counted":false}
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
```bash
# –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
VIEW_SALT=your-secret-salt-for-hashing
REDIS_URL=redis://localhost:6379

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–∏—á–∞-—Ñ–ª–∞–≥–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
VIEW_TRACK_ON_HOME=false  # –û—Ç–∫–ª—é—á–∏—Ç—å —Ç—Ä–µ–∫–∏–Ω–≥ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π (–µ—Å–ª–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è)
VIEW_DEDUP_WINDOW=30      # –°–µ–∫—É–Ω–¥—ã –¥–ª—è –æ–∫–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30)
```

### Redis –∫–ª—é—á–∏

| –ö–ª—é—á | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | TTL |
|------|------------|-----|
| `token:used:{token}` | –ü–æ–º–µ—Ç–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ | 3600s (1 —á–∞—Å) |
| `view:dedupe:{promptId}:{anchor}:{window}` | –û–∫–Ω–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ | 30s |
| `viewtoken:{tokenId}` | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è) | 600s (10 –º–∏–Ω) |

## SQL –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ —É–∑–∫–æ–º –æ–∫–Ω–µ
```sql
SELECT 
  promptId, 
  fpHash, 
  DATE_TRUNC('second', createdAt) AS ts, 
  COUNT(*) AS count
FROM PromptViewEvent 
WHERE 
  promptId = 'YOUR_PROMPT_ID' 
  AND createdAt > NOW() - INTERVAL '10 minutes'
GROUP BY 1, 2, 3 
HAVING COUNT(*) > 1 
ORDER BY ts DESC;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
```sql
SELECT 
  viewTokenId, 
  COUNT(*) AS uses
FROM PromptViewEvent 
WHERE 
  promptId = 'YOUR_PROMPT_ID' 
  AND viewTokenId IS NOT NULL
GROUP BY 1 
HAVING COUNT(*) > 1;
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
```sql
SELECT 
  reason, 
  COUNT(*) AS count,
  DATE_TRUNC('hour', createdAt) AS hour
FROM PromptViewEvent 
WHERE 
  isCounted = false
  AND createdAt > NOW() - INTERVAL '24 hours'
GROUP BY 1, 3
ORDER BY 3 DESC, 2 DESC;
```

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏

### Acceptance Criteria (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ)

1. ‚úÖ –û–¥–∏–Ω –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `/prompt/{id}` = –º–∞–∫—Å–∏–º—É–º 1 —É—á—Ç—ë–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥
2. ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç `/api/track-view` –¥–ª—è —Ç–æ–≥–æ –∂–µ –ø—Ä–æ–º–ø—Ç–∞
3. ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–º–ø—Ç–∞ < 30s ‚Üí `{counted: false, reason: 'DEDUP_WINDOW'}`
4. ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ ‚Üí `{error: 'INVALID_OR_REUSED_TOKEN'}`
5. ‚úÖ –ù–µ–≤–µ—Ä–Ω—ã–π referer ‚Üí `{error: 'INVALID_REFERER_FOR_VIEW'}`
6. ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ `x-fingerprint` –∑–∞–≥–æ–ª–æ–≤–∫–∞
7. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
8. ‚úÖ Unit –∏ E2E —Ç–µ—Å—Ç—ã

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
```bash
# –§—Ä–æ–Ω—Ç–µ–Ω–¥ (–±—Ä–∞—É–∑–µ—Ä–Ω–∞—è –∫–æ–Ω—Å–æ–ª—å)
[VIEW_TRACKING] Starting track view
[VIEW_TRACKING] Track-view response

# –ë—ç–∫–µ–Ω–¥ (server logs)
[TRACK-VIEW:{requestId}] API called
[TRACK-VIEW:{requestId}] Token already used
[TRACK-VIEW:{requestId}] Dedup window active
[TRACK-VIEW:{requestId}] Views incremented
```

**–ê–ª–µ—Ä—Ç—ã –≤ PromptViewEvent:**
- `reason: 'TOKEN_REUSED'` - –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- `reason: 'DEDUP_WINDOW'` - –ø–æ–ø—ã—Ç–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 30s –æ–∫–Ω–∞
- `reason: 'INVALID_REFERER'` - –Ω–µ–≤–µ—Ä–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø—Ä–æ—Å–∞
- `reason: 'AF_BLOCKED'` - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –∞–Ω—Ç–∏—Ñ—Ä–æ–¥–æ–º

## –í–æ–∑–º–æ–∂–Ω—ã–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å Sentry/monitoring –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤ –æ –≤—ã—Å–æ–∫–æ–º –ø—Ä–æ—Ü–µ–Ω—Ç–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ `isCounted: true/false` –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∞–≥—Ä–µ–≥–∞—Ü–∏—é –≤ `ViewAnalytics` (cron job)

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ
- [ ] –£–ª—É—á—à–∏—Ç—å —Ç–æ–∫–µ–Ω—ã: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é —Å –ø–æ–¥–ø–∏—Å—å—é HMAC
- [ ] –î–æ–±–∞–≤–∏—Ç—å CAPTCHA –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–º–Ω–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å batch-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ
- [ ] –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ event streaming (Kafka/RabbitMQ) –¥–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- [ ] ML-–º–æ–¥–µ–ª—å –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –±–æ—Ç–æ–≤
- [ ] –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π rate limiting (Redis Cluster)

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞.** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã 5 —É—Ä–æ–≤–Ω–µ–π –∑–∞—â–∏—Ç—ã –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞:
1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ (sessionStorage + —Ñ–ª–∞–≥–∏)
2. –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã (Redis)
3. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (30s –æ–∫–Ω–æ)
4. Referer –ø—Ä–æ–≤–µ—Ä–∫–∞
5. –ê–Ω—Ç–∏—Ñ—Ä–æ–¥

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è **–º–∞–∫—Å–∏–º—É–º –æ–¥–∏–Ω —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥** –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –¥–∞–∂–µ –ø—Ä–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö –∏–ª–∏ –ø–æ–ø—ã—Ç–∫–∞—Ö –æ–±—Ö–æ–¥–∞ –∑–∞—â–∏—Ç—ã.

**–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ. –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É.**


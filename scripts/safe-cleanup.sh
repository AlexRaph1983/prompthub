#!/bin/bash
set -euo pipefail

echo "=========================================="
echo "üßπ –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –î–ò–°–ö–û–í–û–ì–û –ü–†–û–°–¢–†–ê–ù–°–¢–í–ê"
echo "=========================================="
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
safe_remove() {
    local path="$1"
    local description="$2"
    
    if [ -e "$path" ]; then
        local size=$(du -sh "$path" 2>/dev/null | awk '{print $1}' || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        echo "  –£–¥–∞–ª–µ–Ω–∏–µ: $description ($size)"
        rm -rf "$path" 2>/dev/null && echo "    ‚úÖ –£–¥–∞–ª–µ–Ω–æ" || echo "    ‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏"
    else
        echo "  –ü—Ä–æ–ø—É—Å–∫: $description (–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)"
    fi
}

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏..."
cd /root/prompthub || exit 1
CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
echo "  –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $CURRENT_COMMIT"
echo ""

# 1. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3)
echo "1Ô∏è‚É£ –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• –ë–≠–ö–ê–ü–û–í:"
BACKUP_DIRS=$(find /root -maxdepth 1 -type d -name "backup_prompthub_*" -printf "%T@ %p\n" 2>/dev/null | sort -rn | awk '{print $2}')
BACKUP_COUNT=$(echo "$BACKUP_DIRS" | wc -l)

if [ "$BACKUP_COUNT" -gt 3 ]; then
    TO_REMOVE=$(echo "$BACKUP_DIRS" | tail -n +4)
    REMOVED_COUNT=0
    while IFS= read -r backup_dir; do
        if [ -n "$backup_dir" ] && [ -d "$backup_dir" ]; then
            safe_remove "$backup_dir" "–°—Ç–∞—Ä—ã–π –±—ç–∫–∞–ø: $(basename "$backup_dir")"
            REMOVED_COUNT=$((REMOVED_COUNT + 1))
        fi
    done <<< "$TO_REMOVE"
    echo "  ‚úÖ –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤: $REMOVED_COUNT"
    echo "  üì¶ –û—Å—Ç–∞–≤–ª–µ–Ω–æ –±—ç–∫–∞–ø–æ–≤: $((BACKUP_COUNT - REMOVED_COUNT))"
else
    echo "  ‚ÑπÔ∏è –ë—ç–∫–∞–ø–æ–≤ –º–µ–Ω—å—à–µ 3, –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª—è–µ–º"
fi
echo ""

# 2. –û—á–∏—Å—Ç–∫–∞ .next –ø–∞–ø–æ–∫ (–ø–µ—Ä–µ—Å–æ–±–µ—Ä—É—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –¥–µ–ø–ª–æ–µ)
echo "2Ô∏è‚É£ –û–ß–ò–°–¢–ö–ê NEXT.JS BUILD ARTIFACTS:"
if [ -d /root/prompthub/.next ]; then
    safe_remove "/root/prompthub/.next" ".next –ø–∞–ø–∫–∞ (–ø–µ—Ä–µ—Å–æ–±–µ—Ä–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ)"
fi
echo ""

# 3. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö PM2 –ª–æ–≥–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫)
echo "3Ô∏è‚É£ –û–ß–ò–°–¢–ö–ê PM2 –õ–û–ì–û–í:"
if command -v pm2 >/dev/null 2>&1; then
    if [ -d ~/.pm2/logs ]; then
        # –û—á–∏—â–∞–µ–º –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
        find ~/.pm2/logs -type f -name "*.log" -mtime +7 -delete 2>/dev/null && echo "  ‚úÖ –£–¥–∞–ª–µ–Ω—ã –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π" || echo "  ‚ÑπÔ∏è –ù–µ—Ç —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤"
        # –û—á–∏—â–∞–µ–º —Ä–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
        find ~/.pm2/logs -type f -name "*.log.*" -delete 2>/dev/null && echo "  ‚úÖ –£–¥–∞–ª–µ–Ω—ã —Ä–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏" || echo "  ‚ÑπÔ∏è –ù–µ—Ç —Ä–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤"
    fi
fi
echo ""

# 4. –û—á–∏—Å—Ç–∫–∞ npm –∫—ç—à–∞
echo "4Ô∏è‚É£ –û–ß–ò–°–¢–ö–ê NPM –ö–≠–®–ê:"
if command -v npm >/dev/null 2>&1; then
    npm cache clean --force 2>/dev/null && echo "  ‚úÖ NPM –∫—ç—à –æ—á–∏—â–µ–Ω" || echo "  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ npm –∫—ç—à–∞"
fi
echo ""

# 5. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "5Ô∏è‚É£ –û–ß–ò–°–¢–ö–ê –í–†–ï–ú–ï–ù–ù–´–• –§–ê–ô–õ–û–í:"
# –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª—ã –≤ /tmp —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
find /tmp -type f -mtime +7 -delete 2>/dev/null && echo "  ‚úÖ –£–¥–∞–ª–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π" || echo "  ‚ÑπÔ∏è –ù–µ—Ç —Å—Ç–∞—Ä—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
echo ""

# 6. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
echo "6Ô∏è‚É£ –û–ß–ò–°–¢–ö–ê –°–ò–°–¢–ï–ú–ù–´–• –õ–û–ì–û–í:"
# –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
if [ -d /var/log ]; then
    find /var/log -type f -name "*.log.*" -mtime +30 -delete 2>/dev/null && echo "  ‚úÖ –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ —Ä–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏" || echo "  ‚ÑπÔ∏è –ù–µ—Ç —Å—Ç–∞—Ä—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤"
    find /var/log -type f -name "*.gz" -mtime +30 -delete 2>/dev/null && echo "  ‚úÖ –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ —Å–∂–∞—Ç—ã–µ –ª–æ–≥–∏" || echo "  ‚ÑπÔ∏è –ù–µ—Ç —Å—Ç–∞—Ä—ã—Ö —Å–∂–∞—Ç—ã—Ö –ª–æ–≥–æ–≤"
fi
echo ""

# 7. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö PM2 –¥–∞–º–ø–æ–≤
echo "7Ô∏è‚É£ –û–ß–ò–°–¢–ö–ê PM2 –î–ê–ú–ü–û–í:"
if [ -f ~/.pm2/dump.pm2 ]; then
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–≥–æ –¥–∞–º–ø–∞
    cp ~/.pm2/dump.pm2 ~/.pm2/dump.pm2.backup.$(date +%Y%m%d) 2>/dev/null || true
    echo "  ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –¥–∞–º–ø–∞ PM2"
fi
echo ""

# –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo "=========================================="
echo "üìä –ò–¢–û–ì–û–í–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –î–ò–°–ö–ï:"
df -h / | tail -1
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
echo "üîç –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–û–°–¢–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø:"
if command -v pm2 >/dev/null 2>&1; then
    PM2_STATUS=$(pm2 list | grep prompthub || echo "")
    if [ -n "$PM2_STATUS" ]; then
        echo "  ‚úÖ PM2 –ø—Ä–æ—Ü–µ—Å—Å prompthub –Ω–∞–π–¥–µ–Ω"
        pm2 list | grep prompthub
    else
        echo "  ‚ö†Ô∏è PM2 –ø—Ä–æ—Ü–µ—Å—Å prompthub –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo ""
echo "üåê –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø:"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null || echo "000")
if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
    echo "  ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç (HTTP $HTTP_CODE)"
else
    echo "  ‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (HTTP $HTTP_CODE)"
    echo "  üí° –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å: pm2 restart prompthub"
fi

echo ""
echo "=========================================="
echo "‚úÖ –û–ß–ò–°–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê"
echo "=========================================="


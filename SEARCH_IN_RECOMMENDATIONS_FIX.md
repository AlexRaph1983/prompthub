# Исправление поиска в режиме рекомендаций

## Root Cause

**Проблема**: Поиск не работал в режиме рекомендаций, хотя работал в обычном режиме.

**Причина**: 
1. При загрузке рекомендаций параметр `q` (поисковый запрос) не передавался в `/api/recommendations`
2. useEffect для загрузки рекомендаций не реагировал на изменение поискового запроса (зависимости не включали `debouncedValue` или `state.searchQuery`)
3. Поиск выполнялся только на клиенте через `filterByState`, который фильтровал уже загруженные рекомендации, не запрашивая новые с сервера

## Решение

### 1. Добавлена передача параметра `q` в API рекомендаций

В `components/pages/HomePage.tsx`:
- При формировании URL для `/api/recommendations` теперь добавляется параметр `q`, если есть поисковый запрос
- Добавлены зависимости `debouncedValue` и `state.searchQuery` в useEffect для перезагрузки рекомендаций при изменении поиска

### 2. Синхронизация состояния поиска

- Добавлен useEffect для синхронизации `debouncedValue` с `state.searchQuery`

### 3. Улучшена клиентская фильтрация

- При наличии серверного поиска применяется только фильтрация по модели/категории/языку (без дублирования поиска на клиенте)
- Без серверного поиска применяется полная клиентская фильтрация

### 4. Добавлено логирование для диагностики

- Логирование на клиенте: `[RECO]` префикс для всех операций с рекомендациями
- Логирование на сервере: `[RECO API]` префикс в `/api/recommendations`

### 5. Добавлены тесты

- Unit тесты в `__tests__/api/recommendations.test.ts` для проверки поддержки параметра `q`
- E2E тесты в `__tests__/e2e/recommendations.e2e.test.ts` для проверки поиска через API

## Измененные файлы

### Клиент
- `components/pages/HomePage.tsx`: Добавлена передача `q` параметра и зависимости в useEffect

### Сервер
- `app/api/recommendations/route.ts`: Добавлено логирование для диагностики (параметр `q` уже поддерживался)

### Тесты
- `__tests__/api/recommendations.test.ts`: Добавлены тесты для поиска
- `__tests__/e2e/recommendations.e2e.test.ts`: Добавлены E2E тесты для поиска

## Как работает поиск в разных режимах

### Обычный режим (sortMode === 'date')
- Поиск выполняется через `/api/prompts?q=...`
- Результаты фильтруются на сервере
- Клиентская фильтрация используется только для дополнительных фильтров (модель, категория, язык)

### Режим рекомендаций (sortMode === 'recommendations')
- Поиск выполняется через `/api/recommendations?q=...`
- Если есть поисковый запрос, используется `enhancedSearch` для серверной фильтрации
- Затем применяется ранжирование по релевантности
- Клиентская фильтрация применяется только для модели/категории/языка (без дублирования поиска)

## Команды для запуска тестов

```bash
# Unit тесты для API рекомендаций
npm test -- __tests__/api/recommendations.test.ts

# E2E тесты для рекомендаций
npx playwright test __tests__/e2e/recommendations.e2e.test.ts

# Все тесты рекомендаций
npm test -- recommendations
```

## Предотвращение повторения проблемы

1. **Единый источник истины**: Поиск должен всегда быть серверным, клиентская фильтрация только для дополнительных фильтров
2. **Зависимости useEffect**: Все используемые значения должны быть в массиве зависимостей
3. **Тесты**: Добавлены тесты, которые проверяют наличие параметра `q` в запросах
4. **Логирование**: Добавлено логирование для диагностики проблем в будущем

## Заметки

- API `/api/recommendations` уже поддерживал параметр `q`, проблема была только на клиенте
- Client-side фильтрация сохранена для случаев без поиска (для производительности)
- Кэш рекомендаций включает поисковый запрос в ключ, что предотвращает неправильные попадания в кэш


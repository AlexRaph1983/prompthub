# üîç –£–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–∞ –±—ã–ª–∞ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–∞ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –º—É—Å–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. **–¢–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ **Enter** –∏–ª–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
- ‚úÖ Debounce 600ms –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ø–∞–º–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–æ–∏—Å–∫–∞

### 2. **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è**
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 3 —Å–∏–º–≤–æ–ª–∞
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç–æ–ø-—Å–ª–æ–≤ (—Ä—É—Å—Å–∫–∏–µ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ)
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–æ–¥—Ä—è–¥ —Å–∏–º–≤–æ–ª–æ–≤
- ‚úÖ NFKC –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è Unicode

### 3. **–°–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è**
- ‚úÖ Regex –≤–∞–ª–∏–¥–∞—Ü–∏—è: `/[^A-Za-z0-9\u0400-\u04FF\s\-]/`
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ —Ö—ç—à—É –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–∞–∑–∞
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (5 –º–∏–Ω—É—Ç)

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### **–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `lib/search-utils.ts` - –£—Ç–∏–ª–∏—Ç—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `__tests__/lib/search-utils.test.ts` - Unit —Ç–µ—Å—Ç—ã —É—Ç–∏–ª–∏—Ç
- `__tests__/hooks/useSearchTracking.test.tsx` - Unit —Ç–µ—Å—Ç—ã —Ö—É–∫–∞
- `__tests__/api/search-tracking.test.ts` - Unit —Ç–µ—Å—Ç—ã API
- `__tests__/e2e/search-tracking.e2e.test.ts` - E2E —Ç–µ—Å—Ç—ã
- `prisma/migrations/20241202_add_query_hash/migration.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
- `scripts/run-migration-and-tests.sh` - –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤

### **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `hooks/useSearchTracking.ts` - –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ö—É–∫ —Å debounce –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- `app/api/search-tracking/route.ts` - –°–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- `PromptsClient.tsx` - –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –∏ blur —Å–æ–±—ã—Ç–∏–π
- `prisma/schema.prisma` - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ queryHash

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:**
```typescript
// –î–æ: "  HELLO    WORLD  "
// –ü–æ—Å–ª–µ: "hello world"
```

### **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç–æ–ø-—Å–ª–æ–≤:**
```typescript
// –î–æ: "hello and world"
// –ü–æ—Å–ª–µ: "hello world"
```

### **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:**
```typescript
// –•—ç—à —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ: query + userId/ipHash
const hash = createQueryHash(query, userId, ipHash)
```

### **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–æ–≤:**
```typescript
// –†–∞–∑—Ä–µ—à–µ–Ω—ã: A-Z, a-z, 0-9, –∫–∏—Ä–∏–ª–ª–∏—Ü–∞, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã
const VALID_QUERY_REGEX = /^[A-Za-z0-9\u0400-\u04FF\s\-]+$/
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **Unit —Ç–µ—Å—Ç—ã:**
```bash
npm test -- --testPathPattern="search-utils|useSearchTracking|search-tracking"
```

### **E2E —Ç–µ—Å—Ç—ã:**
```bash
npx playwright test __tests__/e2e/search-tracking.e2e.test.ts
```

### **–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª:**
```bash
bash scripts/run-migration-and-tests.sh
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **–î–æ —É–ª—É—á—à–µ–Ω–∏–π:**
- ‚ùå –ú—É—Å–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: "–∞", "–∞–±", "–ø—Ä–æ–≤", "–ø—Ä–æ–≤–µ—Ä"
- ‚ùå –î—É–±–ª–∏–∫–∞—Ç—ã: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å = 10+ –∑–∞–ø–∏—Å–µ–π
- ‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–∏–º–≤–æ–ª–æ–≤
- ‚ùå –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç–æ–ø-—Å–ª–æ–≤

### **–ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:**
- ‚úÖ –¢–æ–ª—å–∫–æ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: "–ø—Ä–æ–≤–µ—Ä–∫–∞", "—Ç–µ—Å—Ç"
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å = 1 –∑–∞–ø–∏—Å—å
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —É–±—Ä–∞–Ω—ã —Å—Ç–æ–ø-—Å–ª–æ–≤–∞

## üöÄ –î–µ–ø–ª–æ–π

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î:**
```bash
npx prisma migrate dev --name add_query_hash
```

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
npm test
```

3. **–î–µ–ø–ª–æ–π:**
```bash
git add .
git commit -m "–£–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–∞"
git push origin main
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### **–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:**
- `‚úÖ Search query tracked: [query]` - —É—Å–ø–µ—à–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- `‚ùå Invalid search query rejected: [reason]` - –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
- `‚ö†Ô∏è Duplicate search query detected: [query]` - –¥—É–±–ª–∏–∫–∞—Ç

### **–ú–µ—Ç—Ä–∏–∫–∏:**
- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –Ω–∞ 80-90%
- –ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –º—É—Å–æ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üîç –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

–í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ:
- ‚úÖ –ü–∞–∫–µ—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø–æ–∏—Å–∫–∞
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

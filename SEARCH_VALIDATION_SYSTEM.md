# üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –ø—Å–µ–≤–¥–æ-–∑–∞–ø—Ä–æ—Å–æ–≤

## üìã –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø—Å–µ–≤–¥–æ-–∑–∞–ø—Ä–æ—Å–æ–≤, –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π.

## üéØ –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### **1. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- ‚úÖ `query` - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (—Å—Ç—Ä–æ–∫–∞)
- ‚úÖ `finished=true` - —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ Enter/blur)

### **2. –ü—Ä–∞–≤–∏–ª–∞ –¥–ª–∏–Ω—ã:**
- ‚úÖ –ú–∏–Ω–∏–º—É–º: **3 —Å–∏–º–≤–æ–ª–∞**
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º: **200 —Å–∏–º–≤–æ–ª–æ–≤**

### **3. –ü—Ä–∞–≤–∏–ª–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è:**
- ‚úÖ –ú–∏–Ω–∏–º—É–º **40% –±—É–∫–≤** (–∏—Å–∫–ª—é—á–∞—è –ø—Ä–æ–±–µ–ª—ã)
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º **3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–∞ –ø–æ–¥—Ä—è–¥**
- ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä
- ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –∏–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤

### **4. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚úÖ **NFKC Unicode** –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ Trim –∏ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤

## üìÅ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### **–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**

#### **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- `lib/search-validation.ts` - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `lib/search-metrics.ts` - –°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫
- `app/api/admin/search-metrics/route.ts` - API –¥–ª—è –º–µ—Ç—Ä–∏–∫
- `components/admin/AdminSearchMetrics.tsx` - UI –¥–ª—è –º–µ—Ç—Ä–∏–∫

#### **–¢–µ—Å—Ç—ã:**
- `__tests__/lib/search-validation.test.ts` - Unit —Ç–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `__tests__/lib/search-metrics.test.ts` - Unit —Ç–µ—Å—Ç—ã –º–µ—Ç—Ä–∏–∫
- `__tests__/e2e/search-validation.e2e.test.ts` - E2E —Ç–µ—Å—Ç—ã

#### **–ú–∏–≥—Ä–∞—Ü–∏–∏:**
- `prisma/migrations/20241202_add_search_metrics/migration.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è

### **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `app/api/search-tracking/route.ts` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–æ–≤–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- `hooks/useSearchTracking.ts` - –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–ª–∞–≥–∞ finished
- `prisma/schema.prisma` - –ú–æ–¥–µ–ª—å SearchMetrics

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **–í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:**
```typescript
const validation = validateSearchQuery(query, finished)
if (!validation.valid) {
  await incrementRejectedCount(validation.reason!)
  return { error: validation.reason }
}
```

### **–ú–µ—Ç—Ä–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:**
```typescript
// –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
await incrementSavedCount()

// –ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏
await incrementRejectedCount('TOO_SHORT')
```

### **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:**
```typescript
const queryHash = createQueryHash(normalizedQuery, userId, ipHash)
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
```

## üìä –°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫

### **–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- `countSaved` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `countRejected` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `acceptanceRate` - –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `rejectionRate` - –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- –ü—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
- –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω
- –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è

### **API endpoints:**
```bash
GET /api/admin/search-metrics
GET /api/admin/search-metrics?includeStats=true
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **Unit —Ç–µ—Å—Ç—ã:**
```bash
npm test -- --testPathPattern="search-validation|search-metrics"
```

### **E2E —Ç–µ—Å—Ç—ã:**
```bash
npx playwright test __tests__/e2e/search-validation.e2e.test.ts
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **–î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:**
- ‚ùå –ú—É—Å–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: "–∞", "–∞–±", "123456", "!!!!!"
- ‚ùå –ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–∏–º–≤–æ–ª–µ
- ‚ùå –ù–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### **–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:**
- ‚úÖ –¢–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: "–ø—Ä–æ–≤–µ—Ä–∫–∞", "—Ç–µ—Å—Ç –ø–æ–∏—Å–∫–∞"
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å –ø—Ä–∏—á–∏–Ω–∞–º–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î –Ω–∞ 90%+

## üîç –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

### **–ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫:**
- üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ)
- üìà –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- üîç –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
- üìã –ü—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏

### **–ù–∞–≤–∏–≥–∞—Ü–∏—è:**
```
/admin/search-metrics - –ú–µ—Ç—Ä–∏–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
/admin/search-analytics - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞
```

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

### **–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ SearchMetrics:**
```sql
CREATE TABLE "SearchMetrics" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "count_saved" INTEGER NOT NULL DEFAULT 0,
    "count_rejected" INTEGER NOT NULL DEFAULT 0,
    "rejection_reasons" TEXT NOT NULL DEFAULT '{}',
    "last_updated" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

### **–ö–æ–º–∞–Ω–¥—ã –º–∏–≥—Ä–∞—Ü–∏–∏:**
```bash
npx prisma migrate dev --name add_search_metrics
npx prisma db push
```

## üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–°–µ—Ä–≤–µ—Ä–Ω—ã–µ –ª–æ–≥–∏:**
- `‚úÖ Search query tracked: [query]` - —É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- `‚ùå Search query rejected: [reason]` - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Å –ø—Ä–∏—á–∏–Ω–æ–π
- `‚ö†Ô∏è Duplicate search query detected: [query]` - –¥—É–±–ª–∏–∫–∞—Ç

### **–ú–µ—Ç—Ä–∏–∫–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π:**
- `TOO_SHORT` - –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å
- `INSUFFICIENT_LETTERS` - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—É–∫–≤
- `TOO_MANY_CONSECUTIVE_CHARS` - –ú–Ω–æ–≥–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
- `ONLY_NUMBERS` - –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
- `ONLY_SPECIAL_CHARS` - –¢–æ–ª—å–∫–æ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã
- `QUERY_NOT_FINISHED` - –ó–∞–ø—Ä–æ—Å –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã

1. **–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö** - —Ç–æ–ª—å–∫–æ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
3. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
5. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è

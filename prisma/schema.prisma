generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                    String          @id @default(cuid())
  name                  String?
  email                 String?         @unique
  image                 String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @default(now()) @updatedAt
  bio                   String?
  website               String?
  telegram              String?
  github                String?
  twitter               String?
  linkedin              String?
  reputationScore       Int             @default(0)
  reputationPromptCount Int             @default(0)
  reputationRatingsSum  Int             @default(0)
  reputationRatingsCnt  Int             @default(0)
  reputationLikesCnt    Int             @default(0)
  reputationSavesCnt    Int             @default(0)
  reputationCommentsCnt Int             @default(0)
  adminUser             AdminUser?
  articles              Article[]
  comments              Comment[]
  likes                 Like[]
  prompts               Prompt[]
  ratings               Rating[]
  reviews               Review[]
  saves                 Save[]
  preferences           UserPreference?
}

model Prompt {
  id            String            @id @default(cuid())
  title         String
  description   String
  prompt        String
  model         String
  lang          String
  category      String
  tags          String
  license       String
  authorId      String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now()) @updatedAt
  averageRating Float             @default(0)
  totalRatings  Int               @default(0)
  views         Int               @default(0)
  categoryId    String?
  comments      Comment[]
  likes         Like[]
  categoryRef   Category?         @relation(fields: [categoryId], references: [id])
  author        User              @relation(fields: [authorId], references: [id])
  promptTags    PromptTag[]
  vectors       PromptVector?
  viewEvents    PromptViewEvent[]
  ratings       Rating[]
  reviews       Review[]
  saves         Save[]

  @@unique([title, authorId])
  @@index([category])
  @@index([categoryId])
  @@index([updatedAt])
  @@index([category, updatedAt])
  @@index([categoryId, updatedAt])
}

model Rating {
  id        String   @id @default(cuid())
  value     Int
  userId    String
  promptId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  prompt    Prompt   @relation(fields: [promptId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, promptId])
}

/// Review: расширенная оценка с текстовым комментарием
model Review {
  id        String   @id @default(cuid())
  promptId  String
  userId    String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  prompt    Prompt   @relation(fields: [promptId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([promptId, userId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  promptId  String
  createdAt DateTime @default(now())
  prompt    Prompt   @relation(fields: [promptId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, promptId])
}

model Save {
  id        String   @id @default(cuid())
  userId    String
  promptId  String
  createdAt DateTime @default(now())
  prompt    Prompt   @relation(fields: [promptId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, promptId])
}

model Comment {
  id        String   @id @default(cuid())
  userId    String
  promptId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  prompt    Prompt   @relation(fields: [promptId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

/// User saved preferences to guide recommendations
model UserPreference {
  userId     String   @id
  categories Json
  models     Json
  languages  Json
  tags       Json
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])
}

/// Logged user interactions with prompts for personalization
model PromptInteraction {
  id        String   @id @default(cuid())
  userId    String
  promptId  String
  type      String
  weight    Float    @default(1)
  createdAt DateTime @default(now())

  @@index([userId, promptId])
  @@index([promptId])
}

/// Cached prompt vectors for fast similarity queries
model PromptVector {
  promptId  String   @id
  vector    Json
  updatedAt DateTime @updatedAt
  prompt    Prompt   @relation(fields: [promptId], references: [id])
}

model PromptViewEvent {
  id          String   @id @default(cuid())
  promptId    String
  userId      String?
  ipHash      String?
  uaHash      String?
  fpHash      String?
  viewTokenId String?
  isCounted   Boolean  @default(false)
  reason      String?
  createdAt   DateTime @default(now())
  prompt      Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@index([promptId, createdAt])
  @@index([userId, promptId, createdAt])
  @@index([ipHash, createdAt])
  @@index([isCounted, createdAt])
}

/// Система мониторинга и алертов для просмотров
model ViewMonitoringAlert {
  id         String    @id @default(cuid())
  type       String
  severity   String
  message    String
  metadata   Json?
  isResolved Boolean   @default(false)
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([type, createdAt])
  @@index([severity, isResolved])
}

/// Агрегированная статистика просмотров для аналитики
model ViewAnalytics {
  id            String   @id @default(cuid())
  promptId      String
  date          DateTime
  totalViews    Int      @default(0)
  countedViews  Int      @default(0)
  rejectedViews Int      @default(0)
  uniqueUsers   Int      @default(0)
  uniqueGuests  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([promptId, date])
  @@index([date])
  @@index([promptId, date])
}

/// Ежедневная агрегированная статистика просмотров и копирований
model PromptDailyStats {
  id        Int      @id @default(autoincrement())
  date      DateTime
  promptId  String   @default("global")
  views     Int      @default(0)
  copies    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, promptId])
  @@index([date])
  @@index([promptId, date])
}

/// Отслеживание поисковых запросов пользователей для аналитики
model SearchQuery {
  id            String   @id @default(cuid())
  query         String
  queryHash     String?
  userId        String?
  ipHash        String?
  userAgent     String?
  resultsCount  Int      @default(0)
  clickedResult String?
  sessionId     String?
  createdAt     DateTime @default(now())

  @@index([query, createdAt])
  @@index([queryHash])
  @@index([queryHash, userId, ipHash, createdAt])
  @@index([userId, createdAt])
  @@index([createdAt])
}

/// Расширение модели User для админских функций
model AdminUser {
  id          String   @id @default(cuid())
  userId      String   @unique
  role        String   @default("admin")
  permissions Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  user        User     @relation(fields: [userId], references: [id])

  @@index([role])
}

/// Метрики для системы валидации поисковых запросов
model SearchMetrics {
  id               String   @id @default("main")
  countSaved       Int      @default(0) @map("count_saved")
  countRejected    Int      @default(0) @map("count_rejected")
  rejectionReasons String   @default("{}") @map("rejection_reasons")
  lastUpdated      DateTime @default(now()) @map("last_updated")

  @@index([id])
}

/// Категории промптов с поддержкой иерархии и i18n
model Category {
  id            String     @id @default(cuid())
  nameRu        String
  nameEn        String
  slug          String     @unique
  descriptionRu String?
  descriptionEn String?
  parentId      String?
  isActive      Boolean    @default(true)
  sortOrder     Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  promptCount   Int        @default(0)
  parent        Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[] @relation("CategoryHierarchy")
  prompts       Prompt[]

  @@index([parentId])
  @@index([slug])
  @@index([isActive, sortOrder])
  @@index([parentId, sortOrder])
}

/// Теги для промптов
model Tag {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  description String?
  isNsfw      Boolean      @default(false)
  isActive    Boolean      @default(true)
  color       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  promptCount Int          @default(0)
  articleTags ArticleTag[]
  promptTags  PromptTag[]

  @@index([slug])
  @@index([isActive])
  @@index([isNsfw])
}

/// Связь многие-ко-многим между промптами и тегами
model PromptTag {
  id       String @id @default(cuid())
  promptId String
  tagId    String
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  prompt   Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@unique([promptId, tagId])
  @@index([promptId])
  @@index([tagId])
}

/// Статьи и посты блога с поддержкой i18n
model Article {
  id            String       @id @default(cuid())
  slug          String       @unique
  titleRu       String
  titleEn       String
  descriptionRu String
  descriptionEn String
  contentRu     String
  contentEn     String
  coverImage    String?
  authorId      String
  status        String       @default("draft")
  publishedAt   DateTime?
  viewCount     Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  author        User         @relation(fields: [authorId], references: [id])
  articleTags   ArticleTag[]

  @@index([slug])
  @@index([status, publishedAt])
  @@index([authorId])
  @@index([publishedAt])
}

/// Связь многие-ко-многим между статьями и тегами
model ArticleTag {
  id        String  @id @default(cuid())
  articleId String
  tagId     String
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, tagId])
  @@index([articleId])
  @@index([tagId])
}
